<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shipment Tracking</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f6fa; padding:20px; }
    h1 { color:#0B2341; display:flex; align-items:center; gap:10px; }
    table { width:100%; border-collapse:collapse; background:#fff; }
    th, td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:#0B2341; color:#fff; position:sticky; top:0; }
    tr:hover { background:#eef3ff; }
    button { padding:6px 12px; cursor:pointer; border:none; border-radius:4px; background:#0b2341; color:#fff; }
    button.primary { background:#0b2341; color:#fff; }
    button.secondary { background:#d9dce5; color:#0b2341; }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    .toolbar { margin:12px 0; }
    select { padding:4px; }
    .msg { margin:12px 0; font-size:14px; color:#0B2341; }
    .err { color:#b00; white-space:pre-wrap; text-align:left; }
    .modal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); padding:20px; visibility:hidden; opacity:0; transition:opacity 0.2s ease; }
    .modal.open { visibility:visible; opacity:1; }
    .modal-card { background:#fff; padding:20px; border-radius:8px; width:100%; max-width:500px; box-shadow:0 12px 30px rgba(0,0,0,0.2); }
    .modal-card h2 { margin-top:0; color:#0B2341; }
    .form-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px,1fr)); gap:12px; }
    .form-grid label { display:flex; flex-direction:column; font-size:13px; color:#0B2341; gap:4px; }
    .form-grid input, .form-grid select { padding:8px; border:1px solid #ccd1dd; border-radius:4px; font-size:14px; }
    .form-actions { display:flex; justify-content:flex-end; gap:10px; margin-top:20px; }
    .form-actions .primary { background:#1a73e8; }
    .form-actions .secondary { background:#e5e7ef; color:#0B2341; }
    .form-msg { margin-top:10px; min-height:18px; font-size:13px; color:#b00; }
  </style>
</head>
<body>
  <h1>ðŸš› Shipment Tracking</h1>
  <div class="toolbar">
    <button id="addBtn" class="primary">Add</button>
  </div>
  <div id="msg" class="msg">Cargandoâ€¦</div>

  <table id="table">
    <thead>
      <tr>
        <th>Executive</th><th>Trip</th><th>Trailer</th><th>Reference</th>
        <th>Customer</th><th>Destination</th><th>Status</th><th>Segment</th>
        <th>TR-MX</th><th>TR-USA</th>
        <th>Pickup Appointment</th><th>Arrival at Pickup</th>
        <th>Delivery Appointment</th><th>Arrival at Delivery</th>
        <th>Comments</th><th>Documents</th><th>Tracking</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-card">
      <h2 id="modalTitle">Add shipment</h2>
      <form id="addForm">
        <div class="form-grid">
          <label>Executive
            <input type="text" name="Executive" autocomplete="off" />
          </label>
          <label>Trip <span style="color:#b00;">*</span>
            <input type="text" name="Trip" autocomplete="off" required />
          </label>
          <label>Trailer
            <input type="text" name="Trailer" autocomplete="off" />
          </label>
          <label>Reference
            <input type="text" name="Reference" autocomplete="off" />
          </label>
          <label>Customer
            <input type="text" name="Customer" autocomplete="off" />
          </label>
          <label>Destination
            <input type="text" name="Destination" autocomplete="off" />
          </label>
          <label>Status
            <select name="Status" id="formStatus"></select>
          </label>
          <label>Segment
            <input type="text" name="Segment" autocomplete="off" />
          </label>
          <label>Pickup Appointment
            <input type="datetime-local" name="Pickup Appointment" />
          </label>
        </div>
        <div class="form-msg" id="formMsg"></div>
        <div class="form-actions">
          <button type="button" class="secondary" id="cancelBtn">Cancel</button>
          <button type="submit" class="primary" id="saveBtn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // === TU URL de Web App (exec) ===
    const BASE_URL = "https://script.google.com/macros/s/AKfycbzNzHDowQ7uMywYiLky-59w417vXGMKaVS_Dd2revHJJ02vpNvOHOBkjZujRMu_EXY/exec";
    const READ_URL = BASE_URL + "?mode=display";

    // === Estatus oficiales ===
    const STATUS_OPTIONS = [
      "Drop","Live","Assigned","Loading","In transit MX",
      "At Monterrey yard","At Nuevo Laredo yard","At Queretaro yard",
      "In transit USA","Delivered","Cancelled","Delayed","At destination"
    ];

    const tbody = document.querySelector("#table tbody");
    const msgEl = document.getElementById("msg");
    const addBtn = document.getElementById("addBtn");
    const modal = document.getElementById("modal");
    const cancelBtn = document.getElementById("cancelBtn");
    const addForm = document.getElementById("addForm");
    const formStatus = document.getElementById("formStatus");
    const formMsg = document.getElementById("formMsg");

    const buildStatusOptions = (selected) =>
      STATUS_OPTIONS
        .map(
          (s) => `<option value="${s}" ${s === selected ? "selected" : ""}>${s}</option>`
        )
        .join("");

    formStatus.innerHTML = `<option value="">Select status</option>${buildStatusOptions("")}`;

    const closeModal = () => {
      modal.classList.remove("open");
      addForm.reset();
      formMsg.textContent = "";
      formStatus.innerHTML = `<option value="">Select status</option>${buildStatusOptions("")}`;
    };

    const openModal = () => {
      modal.classList.add("open");
      addForm.elements["Executive"].focus();
    };

    addBtn.addEventListener("click", openModal);
    cancelBtn.addEventListener("click", closeModal);
    modal.addEventListener("click", (ev) => {
      if (ev.target === modal) {
        closeModal();
      }
    });

    const createRow = (row) => {
      const tr = document.createElement("tr");
      const currentStatus = row["Status"] || "";
      const options = buildStatusOptions(currentStatus);

      tr.innerHTML = `
        <td>${row["Executive"] || ""}</td>
        <td>${row["Trip"] || ""}</td>
        <td>${row["Trailer"] || ""}</td>
        <td>${row["Reference"] || ""}</td>
        <td>${row["Customer"] || ""}</td>
        <td>${row["Destination"] || ""}</td>

        <td>
          <select class="status-select" data-trip="${row["Trip"] || ""}">
            ${options}
          </select>
        </td>

        <td>${row["Segment"] || ""}</td>
        <td>${row["TR-MX"] || ""}</td>
        <td>${row["TR-USA"] || ""}</td>
        <td>${row["Pickup Appointment"] || ""}</td>
        <td>${row["Arrival at Pickup"] || ""}</td>
        <td>${row["Delivery Appointment"] || ""}</td>
        <td>${row["Arrival at Delivery"] || ""}</td>
        <td>${row["Comments"] || ""}</td>
        <td>${row["Documents"] || ""}</td>
        <td>${row["Tracking"] || ""}</td>
        <td></td>
      `;
      return tr;
    };

    (async () => {
      try {
        console.log("GET:", READ_URL);
        const res = await fetch(READ_URL, { cache: "no-store" });
        console.log("HTTP status:", res.status, res.statusText);
        if (!res.ok) throw new Error("HTTP " + res.status);

        const text = await res.text();
        console.log("Raw length:", text.length);
        // Si vino HTML (error/consent), muÃ©stralo:
        if (text.trim().startsWith("<")) {
          msgEl.innerHTML = "";
          tbody.innerHTML = `<tr><td colspan="18" class="err">La API devolviÃ³ HTML en lugar de JSON:\n\n${text.slice(0,800)}...</td></tr>`;
          return;
        }

        const rows = JSON.parse(text);
        console.log("Rows parsed:", Array.isArray(rows) ? rows.length : "no-array", rows);

        if (!Array.isArray(rows)) {
          msgEl.innerHTML = "";
          tbody.innerHTML = `<tr><td colspan="18" class="err">Respuesta inesperada (no es arreglo): ${text.slice(0,800)}...</td></tr>`;
          return;
        }
        if (rows.length === 0) {
          msgEl.textContent = "Sin datos para mostrar.";
          return;
        }
        msgEl.textContent = `Cargados ${rows.length} registros.`;

        rows.forEach(row => {
          tbody.appendChild(createRow(row));
        });

      } catch (e) {
        msgEl.innerHTML = "";
        tbody.innerHTML = `<tr><td colspan="18" class="err">Fallo al cargar: ${e.message}</td></tr>`;
        console.error(e);
      }
    })();

    addForm.addEventListener("submit", (ev) => {
      ev.preventDefault();
      formMsg.textContent = "";

      const formData = new FormData(addForm);
      const trip = (formData.get("Trip") || "").toString().trim();

      if (!trip) {
        formMsg.textContent = "Trip is required.";
        addForm.elements["Trip"].focus();
        return;
      }

      const pickupRaw = formData.get("Pickup Appointment");
      const pickupFormatted = pickupRaw ? pickupRaw.toString().replace("T", " ") : "";

      const newRow = {
        "Executive": formData.get("Executive") || "",
        "Trip": trip,
        "Trailer": formData.get("Trailer") || "",
        "Reference": formData.get("Reference") || "",
        "Customer": formData.get("Customer") || "",
        "Destination": formData.get("Destination") || "",
        "Status": formData.get("Status") || "",
        "Segment": formData.get("Segment") || "",
        "TR-MX": "",
        "TR-USA": "",
        "Pickup Appointment": pickupFormatted,
        "Arrival at Pickup": "",
        "Delivery Appointment": "",
        "Arrival at Delivery": "",
        "Comments": "",
        "Documents": "",
        "Tracking": ""
      };

      tbody.prepend(createRow(newRow));
      msgEl.textContent = `Cargados ${tbody.querySelectorAll("tr").length} registros.`;
      closeModal();
    });
  </script>
</body>
</html>
