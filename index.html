<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shipment Tracking</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f6fa; padding:20px; }
    h1 { color:#0B2341; display:flex; align-items:center; gap:10px; }
    table { width:100%; border-collapse:collapse; background:#fff; }
    th, td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:#0B2341; color:#fff; position:sticky; top:0; }
    tr:hover { background:#eef3ff; }
    button { padding:6px 12px; cursor:pointer; border:none; border-radius:4px; background:#0b2341; color:#fff; }
    button.primary { background:#0b2341; color:#fff; }
    button.secondary { background:#d9dce5; color:#0b2341; }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    .toolbar { margin:12px 0; }
    select { padding:4px; }
    .msg { margin:12px 0; font-size:14px; color:#0B2341; }
    .err { color:#b00; white-space:pre-wrap; text-align:left; }
    .modal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); padding:20px; visibility:hidden; opacity:0; transition:opacity 0.2s ease; }
    .modal.open { visibility:visible; opacity:1; }
    .modal-card { background:#fff; padding:20px; border-radius:8px; width:100%; max-width:500px; box-shadow:0 12px 30px rgba(0,0,0,0.2); }
    .modal-card h2 { margin-top:0; color:#0B2341; }
    .form-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px,1fr)); gap:12px; }
    .form-grid label { display:flex; flex-direction:column; font-size:13px; color:#0B2341; gap:4px; }
    .form-grid input, .form-grid select, .form-grid textarea { padding:8px; border:1px solid #ccd1dd; border-radius:4px; font-size:14px; font-family:inherit; }
    .form-grid textarea { resize:vertical; min-height:80px; }
    .form-actions { display:flex; justify-content:flex-end; gap:10px; margin-top:20px; }
    .form-actions .primary { background:#0b57d0; color:#fff; font-weight:600; box-shadow:0 4px 12px rgba(11,87,208,0.35); }
    .form-actions .secondary { background:#e5e7ef; color:#0B2341; }
    .form-msg { margin-top:10px; min-height:18px; font-size:13px; color:#b00; }
    .trip-link { background:none; border:none; color:#1a73e8; text-decoration:underline; padding:0; font:inherit; cursor:pointer; }
    .trip-link:hover, .trip-link:focus { color:#0b57d0; outline:none; }
  </style>
</head>
<body>
  <h1>ðŸš› Shipment Tracking</h1>
  <div class="toolbar">
    <button id="addBtn" class="primary">Add</button>
  </div>
  <div id="msg" class="msg">Cargandoâ€¦</div>

  <table id="table">
    <thead>
      <tr>
        <th>Executive</th><th>Trip</th><th>Trailer</th><th>Reference</th>
        <th>Customer</th><th>Destination</th><th>Status</th><th>Segment</th>
        <th>TR-MX</th><th>TR-USA</th>
        <th>Pickup Appointment</th><th>Arrival at Pickup</th>
        <th>Delivery Appointment</th><th>Arrival at Delivery</th>
        <th>Comments</th><th>Documents</th><th>Tracking</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-card">
      <h2 id="modalTitle">Add shipment</h2>
      <form id="addForm">
        <div class="form-grid">
          <label>Executive
            <input type="text" name="Executive" autocomplete="off" />
          </label>
          <label>Trip <span style="color:#b00;">*</span>
            <input type="text" name="Trip" autocomplete="off" required />
          </label>
          <label>Trailer
            <input type="text" name="Trailer" autocomplete="off" />
          </label>
          <label>Reference
            <input type="text" name="Reference" autocomplete="off" />
          </label>
          <label>Customer
            <input type="text" name="Customer" autocomplete="off" />
          </label>
          <label>Destination
            <input type="text" name="Destination" autocomplete="off" />
          </label>
          <label>Status
            <select name="Status" id="formStatus"></select>
          </label>
          <label>Segment
            <input type="text" name="Segment" autocomplete="off" />
          </label>
          <label>TR-MX
            <input type="text" name="TR-MX" autocomplete="off" />
          </label>
          <label>TR-USA
            <input type="text" name="TR-USA" autocomplete="off" />
          </label>
          <label>Pickup Appointment
            <input type="datetime-local" name="Pickup Appointment" />
          </label>
          <label>Arrival at Pickup
            <input type="datetime-local" name="Arrival at Pickup" />
          </label>
          <label>Delivery Appointment
            <input type="datetime-local" name="Delivery Appointment" />
          </label>
          <label>Arrival at Delivery
            <input type="datetime-local" name="Arrival at Delivery" />
          </label>
          <label>Comments
            <textarea name="Comments"></textarea>
          </label>
          <label>Documents
            <input type="text" name="Documents" autocomplete="off" />
          </label>
          <label>Tracking
            <input type="text" name="Tracking" autocomplete="off" />
          </label>
        </div>
        <div class="form-msg" id="formMsg"></div>
        <div class="form-actions">
          <button type="button" class="secondary" id="cancelBtn">Cancel</button>
          <button type="submit" class="primary" id="saveBtn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // === TU URL de Web App (exec) ===
    const BASE_URL = "https://script.google.com/macros/s/AKfycbzNzHDowQ7uMywYiLky-59w417vXGMKaVS_Dd2revHJJ02vpNvOHOBkjZujRMu_EXY/exec";
    const READ_URL = BASE_URL + "?mode=display";

    // === Estatus oficiales ===
    const STATUS_OPTIONS = [
      "Drop","Live","Assigned","Loading","In transit MX",
      "At Monterrey yard","At Nuevo Laredo yard","At Queretaro yard",
      "In transit USA","Delivered","Cancelled","Delayed","At destination"
    ];

    const COLUMN_KEYS = [
      "Executive","Trip","Trailer","Reference","Customer","Destination",
      "Status","Segment","TR-MX","TR-USA","Pickup Appointment","Arrival at Pickup",
      "Delivery Appointment","Arrival at Delivery","Comments","Documents","Tracking"
    ];

    const DATETIME_FIELDS = [
      "Pickup Appointment","Arrival at Pickup","Delivery Appointment","Arrival at Delivery"
    ];

    const tbody = document.querySelector("#table tbody");
    const msgEl = document.getElementById("msg");
    const addBtn = document.getElementById("addBtn");
    const modal = document.getElementById("modal");
    const cancelBtn = document.getElementById("cancelBtn");
    const addForm = document.getElementById("addForm");
    const formStatus = document.getElementById("formStatus");
    const formMsg = document.getElementById("formMsg");
    const saveBtn = document.getElementById("saveBtn");
    const modalTitle = document.getElementById("modalTitle");
    let editingRow = null;

    const buildStatusOptions = () =>
      STATUS_OPTIONS.map((s) => `<option value="${s}">${s}</option>`).join("");

    formStatus.innerHTML = `<option value="">Select status</option>${buildStatusOptions()}`;

    const toInputDateTime = (value) => {
      if (!value) return "";
      const raw = value.toString().trim();
      if (!raw) return "";

      let datePart = "";
      let timePart = "";

      if (raw.includes("T")) {
        [datePart, timePart = ""] = raw.split("T");
      } else {
        const parts = raw.split(/\s+/);
        if (parts.length >= 2) {
          [datePart, timePart] = [parts[0], parts[1]];
        }
      }

      datePart = datePart.trim();
      timePart = timePart.trim();
      if (!datePart || !timePart) return "";

      const timeMatch = timePart.match(/(\d{1,2}):(\d{1,2})/);
      if (!timeMatch) return "";

      const hours = timeMatch[1].padStart(2, "0");
      const minutes = timeMatch[2].padStart(2, "0");
      const candidate = `${datePart}T${hours}:${minutes}`;

      return /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(candidate) ? candidate : "";
    };

    const fromInputDateTime = (value) => {
      if (!value) return "";
      const raw = value.toString().trim();
      return raw.includes("T") ? raw.replace("T", " ") : raw;
    };

    const normaliseRow = (row = {}) => {
      const normalized = {};
      COLUMN_KEYS.forEach((key) => {
        const value = row[key];
        normalized[key] = value == null ? "" : value.toString();
      });
      return normalized;
    };

    const fillFormFields = (data) => {
      COLUMN_KEYS.forEach((key) => {
        if (key === "Status") {
          const value = data[key] || "";
          if (value && !Array.from(formStatus.options).some((opt) => opt.value === value)) {
            const extraOption = document.createElement("option");
            extraOption.value = value;
            extraOption.textContent = value;
            formStatus.appendChild(extraOption);
          }
          formStatus.value = value;
          return;
        }
        const field = addForm.elements[key];
        if (!field) return;
        let value = data[key] || "";
        if (DATETIME_FIELDS.includes(key)) {
          value = toInputDateTime(value);
        }
        field.value = value;
      });
    };

    const closeModal = () => {
      modal.classList.remove("open");
      addForm.reset();
      formMsg.textContent = "";
      formStatus.value = "";
      addForm.dataset.mode = "add";
      modalTitle.textContent = "Add shipment";
      editingRow = null;
    };

    const openModalForAdd = () => {
      editingRow = null;
      addForm.dataset.mode = "add";
      modalTitle.textContent = "Add shipment";
      formMsg.textContent = "";
      addForm.reset();
      formStatus.value = "";
      modal.classList.add("open");
      addForm.elements["Trip"].focus();
    };

    const openModalForRow = (tr) => {
      const data = normaliseRow(tr._rowData || {});
      editingRow = tr;
      addForm.dataset.mode = "edit";
      modalTitle.textContent = data["Trip"] ? `Trip ${data["Trip"]}` : "Trip";
      formMsg.textContent = "";
      addForm.reset();
      fillFormFields(data);
      modal.classList.add("open");
      addForm.elements["Trip"].focus();
    };

    addBtn.addEventListener("click", openModalForAdd);
    cancelBtn.addEventListener("click", closeModal);
    modal.addEventListener("click", (ev) => {
      if (ev.target === modal) {
        closeModal();
      }
    });

    const createRow = (row) => {
      const tr = document.createElement("tr");
      const data = normaliseRow(row);
      tr._rowData = data;

      COLUMN_KEYS.forEach((key) => {
        const td = document.createElement("td");
        if (key === "Trip") {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "trip-link";
          btn.textContent = data[key];
          btn.addEventListener("click", (event) => {
            event.preventDefault();
            openModalForRow(tr);
          });
          td.appendChild(btn);
        } else {
          td.textContent = data[key];
        }
        tr.appendChild(td);
      });

      const actionTd = document.createElement("td");
      tr.appendChild(actionTd);
      return tr;
    };

    const updateRowElement = (tr, rowData) => {
      const data = normaliseRow(rowData);
      tr._rowData = data;
      COLUMN_KEYS.forEach((key, idx) => {
        const cell = tr.children[idx];
        if (!cell) return;
        if (key === "Trip") {
          const btn = cell.querySelector(".trip-link");
          if (btn) {
            btn.textContent = data[key];
          } else {
            cell.textContent = data[key];
          }
        } else {
          cell.textContent = data[key];
        }
      });
    };

    const renderErrorMessage = (message) => {
      msgEl.textContent = "";
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 18;
      td.className = "err";
      td.textContent = message;
      tr.appendChild(td);
      tbody.replaceChildren(tr);
    };

    (async () => {
      try {
        console.log("GET:", READ_URL);
        const res = await fetch(READ_URL, { cache: "no-store" });
        console.log("HTTP status:", res.status, res.statusText);
        if (!res.ok) throw new Error("HTTP " + res.status);

        const text = await res.text();
        console.log("Raw length:", text.length);
        // Si vino HTML (error/consent), muÃ©stralo:
        if (text.trim().startsWith("<")) {
          renderErrorMessage(
            `La API devolviÃ³ HTML en lugar de JSON:\n\n${text.slice(0, 800)}...`
          );
          return;
        }

        const rows = JSON.parse(text);
        console.log("Rows parsed:", Array.isArray(rows) ? rows.length : "no-array", rows);

        if (!Array.isArray(rows)) {
          renderErrorMessage(
            `Respuesta inesperada (no es arreglo): ${text.slice(0, 800)}...`
          );
          return;
        }
        if (rows.length === 0) {
          msgEl.textContent = "Sin datos para mostrar.";
          return;
        }
        msgEl.textContent = `Cargados ${rows.length} registros.`;

        rows.forEach((row) => {
          tbody.appendChild(createRow(row));
        });

      } catch (e) {
        renderErrorMessage(`Fallo al cargar: ${e.message}`);
        console.error(e);
      }
    })();

    const formDataToRow = (formData) => {
      const record = {};
      COLUMN_KEYS.forEach((key) => {
        let value = formData.get(key);
        if (value == null) {
          value = "";
        }
        value = value.toString();
        if (DATETIME_FIELDS.includes(key)) {
          value = value ? fromInputDateTime(value) : "";
        } else {
          value = value.trim();
        }
        record[key] = value;
      });
      return record;
    };

    const setSavingState = (isSaving, message = "") => {
      saveBtn.disabled = isSaving;
      saveBtn.textContent = isSaving ? "Savingâ€¦" : "Save";
      formMsg.textContent = message;
    };

    addForm.addEventListener("submit", async (ev) => {
      ev.preventDefault();
      formMsg.textContent = "";

      const formData = new FormData(addForm);
      const record = formDataToRow(formData);

      if (!record["Trip"]) {
        formMsg.textContent = "Trip is required.";
        addForm.elements["Trip"].focus();
        return;
      }

      const mode = editingRow ? "update" : "add";
      const payload = { mode, record };

      if (editingRow) {
        payload.originalTrip = editingRow._rowData?.["Trip"] || "";
      }

      try {
        setSavingState(true, "Guardandoâ€¦");
        const response = await fetch(BASE_URL, {
          method: "POST",
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status} ${response.statusText || ""} ${errorText}`.trim());
        }

        const data = await response.json().catch(() => {
          throw new Error("Respuesta invÃ¡lida del servidor.");
        });

        if (!data || data.success === false) {
          const errMessage = data && data.error ? data.error : "La operaciÃ³n no pudo completarse.";
          throw new Error(errMessage);
        }

        const confirmedRecord = normaliseRow(data.row || record);

        if (mode === "update" && editingRow) {
          updateRowElement(editingRow, confirmedRecord);
        } else if (mode === "add") {
          const newRow = createRow(confirmedRecord);
          tbody.prepend(newRow);
        }

        const tripLabel = confirmedRecord["Trip"] || "sin nÃºmero";
        msgEl.textContent = data.message ||
          `Trip ${tripLabel} ${mode === "add" ? "registrado" : "actualizado"} correctamente.`;
        closeModal();
      } catch (error) {
        console.error(error);
        formMsg.textContent = `Error: ${error.message}`;
      } finally {
        setSavingState(false, formMsg.textContent);
      }
    });
  </script>
</body>
</html>
